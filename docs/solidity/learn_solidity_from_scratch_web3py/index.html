<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Solidity 智能合约开发 - 玩转 Web3.py # 前言 # 在前文《Solidity 智能合约开发 - 基础》中，我们学习了 Solidity 的基本语法，并且了解了可以通过 Brownie 与 HardHat 等框架进行调试。但在使用这些封装好的框架之前，我们可以通过 Web3.py 直接与我们本地的 Ganache 节点进行交互，以便更好了解其原理，也为我们后续更好使用框架打好基础。
本文以 Web3.py 为例，实现了基础的合约编译、部署至本地 Ganache 网络、与合约交互等功能。
可以点击这里访问本测试 Demo 代码仓库。
Web3.py # Web3.py 是 Python 的一个开源库，它提供了一个简单的 API，可以让我们通过 Python 程序与以太坊网络进行交互。其 GitHub 地址为 ethereum/web3.py，可以访问其官方文档进行使用。
安装 # 我们可以通过 Python 包管理工具 pip 安装 Web3.py，如下：
pip3 install web3 使用 # 使用 import 导入所需方法即可使用
from web3 import Web3 w3 = Web3(Web3.HTTPProvider(&#34;HTTP://127.0.0.1:7545&#34;)) Solidity 合约编译 # 合约源码 # // SPDX-License-Identifier: MIT pragma solidity ^0."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Solidity 智能合约开发 - 玩转 Web3.py"><meta property="og:description" content="Solidity 智能合约开发 - 玩转 Web3.py # 前言 # 在前文《Solidity 智能合约开发 - 基础》中，我们学习了 Solidity 的基本语法，并且了解了可以通过 Brownie 与 HardHat 等框架进行调试。但在使用这些封装好的框架之前，我们可以通过 Web3.py 直接与我们本地的 Ganache 节点进行交互，以便更好了解其原理，也为我们后续更好使用框架打好基础。
本文以 Web3.py 为例，实现了基础的合约编译、部署至本地 Ganache 网络、与合约交互等功能。
可以点击这里访问本测试 Demo 代码仓库。
Web3.py # Web3.py 是 Python 的一个开源库，它提供了一个简单的 API，可以让我们通过 Python 程序与以太坊网络进行交互。其 GitHub 地址为 ethereum/web3.py，可以访问其官方文档进行使用。
安装 # 我们可以通过 Python 包管理工具 pip 安装 Web3.py，如下：
pip3 install web3 使用 # 使用 import 导入所需方法即可使用
from web3 import Web3 w3 = Web3(Web3.HTTPProvider(&#34;HTTP://127.0.0.1:7545&#34;)) Solidity 合约编译 # 合约源码 # // SPDX-License-Identifier: MIT pragma solidity ^0."><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/blockchain-guide/docs/solidity/learn_solidity_from_scratch_web3py/"><meta property="article:section" content="docs"><title>Solidity 智能合约开发 - 玩转 Web3.py | 区块链入门指南</title><link rel=manifest href=/blockchain-guide/manifest.json><link rel=icon href=/blockchain-guide/favicon.png type=image/x-icon><link rel=stylesheet href=/blockchain-guide/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/blockchain-guide/flexsearch.min.js></script>
<script defer src=/blockchain-guide/zh.search.min.7758dca3d778098e05561d00986b1d2e3d447aef3f51cc2a6b3b3248cebe3962.js integrity="sha256-d1jco9d4CY4FVh0AmGsdLj1Eeu8/UcwqazsySM6+OWI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/blockchain-guide/><span>区块链入门指南</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><p><strong>开始学习</strong></p><ul><li><a href=/blockchain-guide/docs/study_path/>学习路径</a></li></ul></li><li><p><strong>基础知识</strong></p><ul><li><a href=/blockchain-guide/docs/blockchain/blockchain_basic/>区块链基础知识与关键技术</a></li><li><a href=/blockchain-guide/docs/bitcoin/blockchain_bitcoin_basic/>比特币核心技术解读</a></li><li><a href=/blockchain-guide/docs/ethereum/blockchain_ethereum_basic/>Ethereum 核心技术解读</a></li><li><a href=/blockchain-guide/docs/ethereum/blockchain_ethereum_mpt/>Ethereum MPT 详解</a></li><li><a href=/blockchain-guide/docs/solidity/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=/blockchain-guide/docs/solidity/learn_solidity_from_scratch_web3py/ class=active>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=/blockchain-guide/docs/solidity/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li><li><a href=/blockchain-guide/docs/solidity/learn_solidity_from_scratch_hardhat/>Solidity 智能合约开发 - Hardhat 框架使用</a></li><li><a href=/blockchain-guide/docs/solidity/two_phase_commit_contract_practice_in_solidity/>通过状态锁在 Solidity 智能合约中实现两阶段提交</a></li><li><a href=/blockchain-guide/docs/hyperledger_fabric/blockchain_hyperledger_fabric_structure/>Fabric 系统架构详解</a></li><li><a href=/blockchain-guide/docs/hyperledger_fabric/blockchain_hyperledger_fabric_network/>Fabric 网络与安全体系浅析</a></li><li><a href=/blockchain-guide/docs/hyperledger_fabric/blockchain_hyperledger_fabric_gosdk_event/>Fabric Go SDK 事件分析</a></li></ul></li><li><p><strong>热门技术</strong></p><ul><li><a href=/blockchain-guide/docs/ipfs/blockchain_ipfs_structure/>IPFS 技术分析与思考</a></li><li><a href=/blockchain-guide/docs/ipfs/blockchain_ipfs_practice/>IPFS 本地节点搭建</a></li><li><a href=/blockchain-guide/docs/crosschain/blockchain_crosschain/>跨链技术原理与实战</a></li><li><a href=/blockchain-guide/docs/baas/blockchain_baas_platform/>区块链服务平台 (BaaS) 简介</a></li></ul></li><li><p><strong>开发实战</strong></p></li><li><p><strong>附录：资源</strong></p></li><li><p><a href=https://github.com/pseudoyu/blockchain-guide><strong>Fork on Github</strong></a></p></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blockchain-guide/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Solidity 智能合约开发 - 玩转 Web3.py</strong>
<label for=toc-control><img src=/blockchain-guide/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#web3py>Web3.py</a><ul><li><a href=#安装>安装</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#solidity-合约编译>Solidity 合约编译</a><ul><li><a href=#合约源码>合约源码</a></li><li><a href=#读取合约源文件>读取合约源文件</a></li><li><a href=#编译合约>编译合约</a></li></ul></li><li><a href=#本地-ganache-环境>本地 Ganache 环境</a><ul><li><a href=#ganache-gui>Ganache GUI</a></li><li><a href=#ganache-cli-安装>Ganache CLI 安装</a></li><li><a href=#通过-web3-连接本地-ganache-环境>通过 web3 连接本地 Ganache 环境</a></li></ul></li><li><a href=#solidity-合约部署>Solidity 合约部署</a><ul><li><a href=#创建合约>创建合约</a></li><li><a href=#部署合约>部署合约</a></li><li><a href=#与合约交互>与合约交互</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></aside></header><article class=markdown><h1 id=solidity-智能合约开发---玩转-web3py>Solidity 智能合约开发 - 玩转 Web3.py
<a class=anchor href=#solidity-%e6%99%ba%e8%83%bd%e5%90%88%e7%ba%a6%e5%bc%80%e5%8f%91---%e7%8e%a9%e8%bd%ac-web3py>#</a></h1><h2 id=前言>前言
<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h2><p>在前文《<a href=https://www.pseudoyu.com/zh/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a>》中，我们学习了 Solidity 的基本语法，并且了解了可以通过 <a href=https://github.com/eth-brownie/brownie>Brownie</a> 与 <a href=https://github.com/NomicFoundation/hardhat>HardHat</a> 等框架进行调试。但在使用这些封装好的框架之前，我们可以通过 Web3.py 直接与我们本地的 Ganache 节点进行交互，以便更好了解其原理，也为我们后续更好使用框架打好基础。</p><p>本文以 Web3.py 为例，实现了基础的合约编译、部署至本地 Ganache 网络、与合约交互等功能。</p><p>可以点击<a href=https://github.com/pseudoyu/learn-solidity/tree/master/web3_py_simple_storage>这里</a>访问本测试 Demo 代码仓库。</p><h2 id=web3py>Web3.py
<a class=anchor href=#web3py>#</a></h2><p>Web3.py 是 Python 的一个开源库，它提供了一个简单的 API，可以让我们通过 Python 程序与以太坊网络进行交互。其 GitHub 地址为 <a href=https://github.com/ethereum/web3.py>ethereum/web3.py</a>，可以访问其<a href=https://web3py.readthedocs.io/en/stable/>官方文档</a>进行使用。</p><h3 id=安装>安装
<a class=anchor href=#%e5%ae%89%e8%a3%85>#</a></h3><p>我们可以通过 Python 包管理工具 pip 安装 Web3.py，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install web3
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/pip_install_web3.png alt=pip_install_web3></p><h3 id=使用>使用
<a class=anchor href=#%e4%bd%bf%e7%94%a8>#</a></h3><p>使用 <code>import</code> 导入所需方法即可使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> web3 <span style=color:#f92672>import</span> Web3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>w3 <span style=color:#f92672>=</span> Web3(Web3<span style=color:#f92672>.</span>HTTPProvider(<span style=color:#e6db74>&#34;HTTP://127.0.0.1:7545&#34;</span>))
</span></span></code></pre></div><h2 id=solidity-合约编译>Solidity 合约编译
<a class=anchor href=#solidity-%e5%90%88%e7%ba%a6%e7%bc%96%e8%af%91>#</a></h2><h3 id=合约源码>合约源码
<a class=anchor href=#%e5%90%88%e7%ba%a6%e6%ba%90%e7%a0%81>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// SPDX-License-Identifier: MIT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>6</span>.<span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>SimpleStorage</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> favoriteNumber;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> favoriteBool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>People</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint256</span> favoriteNumber;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    People <span style=color:#66d9ef>public</span> person <span style=color:#f92672>=</span> People({favoriteNumber<span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>, name<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Arthur&#34;</span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    People[] <span style=color:#66d9ef>public</span> people;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>mapping</span>(<span style=color:#66d9ef>string</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>uint256</span>) <span style=color:#66d9ef>public</span> nameToFavoriteNumber;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>store</span>(<span style=color:#66d9ef>uint256</span> _favoriteNumber) <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>returns</span> (<span style=color:#66d9ef>uint256</span>) {
</span></span><span style=display:flex><span>        favoriteNumber <span style=color:#f92672>=</span> _favoriteNumber;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> favoriteNumber;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>retrieve</span>() <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>view</span> <span style=color:#66d9ef>returns</span> (<span style=color:#66d9ef>uint256</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> favoriteNumber;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>addPerson</span>(<span style=color:#66d9ef>string</span> <span style=color:#66d9ef>memory</span> _name, <span style=color:#66d9ef>uint256</span> _favoriteNumber) <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        people.push(People({favoriteNumber<span style=color:#f92672>:</span> _favoriteNumber, name<span style=color:#f92672>:</span> _name}));
</span></span><span style=display:flex><span>        nameToFavoriteNumber[_name] <span style=color:#f92672>=</span> _favoriteNumber;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这是一个简单的存储合约，通过一个 People 结构体对象来存储人名和他喜欢数字，通过一个数组来存储多个人的信息，并提供了添加、查找方法。</p><h3 id=读取合约源文件>读取合约源文件
<a class=anchor href=#%e8%af%bb%e5%8f%96%e5%90%88%e7%ba%a6%e6%ba%90%e6%96%87%e4%bb%b6>#</a></h3><p>当我们通过 VSCode 或其他编辑器完成 Solidity 合约编写与语法检查后，需要读取合约源文件并存入变量，供后续编译使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;./SimpleStorage.sol&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> file:
</span></span><span style=display:flex><span>    simple_storage_file <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span>read()
</span></span></code></pre></div><p>上述代码将 <code>SimpleStorage.sol</code> 文件内容读取到变量 <code>simple_storage_file</code> 中。</p><h3 id=编译合约>编译合约
<a class=anchor href=#%e7%bc%96%e8%af%91%e5%90%88%e7%ba%a6>#</a></h3><h4 id=安装-solcx>安装 <code>solcx</code>
<a class=anchor href=#%e5%ae%89%e8%a3%85-solcx>#</a></h4><p>合约编译需要预先安装 <code>solcx</code> 工具。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install py-solc-x
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/pip_install_solcx.png alt=pip_install_solcx></p><h4 id=导入-solcx>导入 <code>solcx</code>
<a class=anchor href=#%e5%af%bc%e5%85%a5-solcx>#</a></h4><p>使用 <code>import</code> 导入所需方法即可使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> solcx <span style=color:#f92672>import</span> compile_standard, install_solc
</span></span></code></pre></div><h4 id=编译>编译
<a class=anchor href=#%e7%bc%96%e8%af%91>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>install_solc(<span style=color:#e6db74>&#34;0.6.0&#34;</span>)
</span></span><span style=display:flex><span>compiled_sol <span style=color:#f92672>=</span> compile_standard(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;language&#34;</span>: <span style=color:#e6db74>&#34;Solidity&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sources&#34;</span>: {<span style=color:#e6db74>&#34;SimpleStorage.sol&#34;</span>: {<span style=color:#e6db74>&#34;content&#34;</span>: simple_storage_file}},
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;outputSelection&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;*&#34;</span>: {<span style=color:#e6db74>&#34;*&#34;</span>: [<span style=color:#e6db74>&#34;abi&#34;</span>, <span style=color:#e6db74>&#34;metadata&#34;</span>, <span style=color:#e6db74>&#34;evm.bytecode&#34;</span>, <span style=color:#e6db74>&#34;evm.sourceMap&#34;</span>]}
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    solc_version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.6.0&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>上述代码我们安装了 0.6.0 版本的 Solidity 编译程序，使用 <code>solcx</code> 库中的<code>compile_standard</code> 方法对上文读取的合约源文件进行编译，并将编译结果存入变量 <code>compiled_sol</code> 中。</p><h4 id=获取编译结果>获取编译结果
<a class=anchor href=#%e8%8e%b7%e5%8f%96%e7%bc%96%e8%af%91%e7%bb%93%e6%9e%9c>#</a></h4><p>编译成功后，使用以下代码将编译好的合约写入文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;compiled_code.json&#34;</span>, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> file:
</span></span><span style=display:flex><span>    json<span style=color:#f92672>.</span>dump(compiled_sol, file)
</span></span></code></pre></div><h4 id=获取-bytecode-与-abi>获取 bytecode 与 abi
<a class=anchor href=#%e8%8e%b7%e5%8f%96-bytecode-%e4%b8%8e-abi>#</a></h4><p>Solidity 合约的部署与交互需要 bytecode 与 abi 两个部分，我们可以通过通过以下代码将其写入对应变量供后续操作使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># get bytecode</span>
</span></span><span style=display:flex><span>bytecode <span style=color:#f92672>=</span> compiled_sol[<span style=color:#e6db74>&#34;contracts&#34;</span>][<span style=color:#e6db74>&#34;SimpleStorage.sol&#34;</span>][<span style=color:#e6db74>&#34;SimpleStorage&#34;</span>][<span style=color:#e6db74>&#34;evm&#34;</span>][
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bytecode&#34;</span>
</span></span><span style=display:flex><span>][<span style=color:#e6db74>&#34;object&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># get abi</span>
</span></span><span style=display:flex><span>abi <span style=color:#f92672>=</span> compiled_sol[<span style=color:#e6db74>&#34;contracts&#34;</span>][<span style=color:#e6db74>&#34;SimpleStorage.sol&#34;</span>][<span style=color:#e6db74>&#34;SimpleStorage&#34;</span>][<span style=color:#e6db74>&#34;abi&#34;</span>]
</span></span></code></pre></div><h2 id=本地-ganache-环境>本地 Ganache 环境
<a class=anchor href=#%e6%9c%ac%e5%9c%b0-ganache-%e7%8e%af%e5%a2%83>#</a></h2><p>智能合约的调试需要将合约部署到实际的链上，而部署到 Ethereum 主网络或 Rinkeby/Koven 等测试网等也不方便调试，因此，我们需要一个本地的区块链环境，Ganache 就给我们提供了一个这样的本地调试环境。Ganache 主要分为 GUI 和 CLI 两种安装方式。</p><h3 id=ganache-gui>Ganache GUI
<a class=anchor href=#ganache-gui>#</a></h3><p>在自己的本地环境，如 Mac/Windows 等系统，我们可以选择带图形界面的 Ganache 客户端，安装与使用都十分便捷，在 <a href=https://trufflesuite.com/ganache/>Ganache 官网</a>选择对应版本即可。</p><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/ganache_download.png alt=ganache_download></p><p>安装完成后选择 Quick Start 即可快速启动一条本地运行的区块链网络，并初始化了十个拥有 100 ETH 的账户，开发调试过程中可使用。</p><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/ganache_account.png alt=ganache_account></p><h3 id=ganache-cli-安装>Ganache CLI 安装
<a class=anchor href=#ganache-cli-%e5%ae%89%e8%a3%85>#</a></h3><p>如果您的系统不支持 GUI 安装，我们可以使用 CLI 安装，安装方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install --global yarn
</span></span><span style=display:flex><span>yarn global add ganache-cli
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/ganache_cli_install.png alt=ganache_cli_install></p><p>等待其安装完成后即可启动本地测试网络，与 Ganache GUI 一致，也包含初始化账户与余额。</p><p><img src=https://cdn.jsdelivr.net/gh/pseudoyu/image-hosting@master/images/ganache_cli_start.png alt=ganache_cli_start></p><h3 id=通过-web3-连接本地-ganache-环境>通过 web3 连接本地 Ganache 环境
<a class=anchor href=#%e9%80%9a%e8%bf%87-web3-%e8%bf%9e%e6%8e%a5%e6%9c%ac%e5%9c%b0-ganache-%e7%8e%af%e5%a2%83>#</a></h3><p>web3 提供了库可以方便地连接到本地 Ganache 环境：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>w3 <span style=color:#f92672>=</span> Web3(Web3<span style=color:#f92672>.</span>HTTPProvider(<span style=color:#e6db74>&#34;HTTP://127.0.0.1:7545&#34;</span>))
</span></span><span style=display:flex><span>chain_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>5777</span>
</span></span><span style=display:flex><span>my_address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0x2F490e1eA91DF6d3cC856e7AC391a20b1eceD6A5&#34;</span>
</span></span><span style=display:flex><span>private_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0fa88bf96b526a955a6126ae4cca0e72c9c82144ae9af37b497eb6afbe8a9711&#34;</span>
</span></span></code></pre></div><h2 id=solidity-合约部署>Solidity 合约部署
<a class=anchor href=#solidity-%e5%90%88%e7%ba%a6%e9%83%a8%e7%bd%b2>#</a></h2><h3 id=创建合约>创建合约
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e5%90%88%e7%ba%a6>#</a></h3><p>我们可以通过 web3 库创建合约。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>SimpleStorage <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>contract(abi<span style=color:#f92672>=</span>abi, bytecode<span style=color:#f92672>=</span>bytecode)
</span></span></code></pre></div><h3 id=部署合约>部署合约
<a class=anchor href=#%e9%83%a8%e7%bd%b2%e5%90%88%e7%ba%a6>#</a></h3><p>部署合约分为三个主要步骤：</p><ol><li>构造交易</li><li>签名交易</li><li>发送交易</li></ol><h4 id=构造交易>构造交易
<a class=anchor href=#%e6%9e%84%e9%80%a0%e4%ba%a4%e6%98%93>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>nonce <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>getTransactionCount(my_address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>transaction <span style=color:#f92672>=</span> SimpleStorage<span style=color:#f92672>.</span>constructor()<span style=color:#f92672>.</span>buildTransaction(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;chainId&#34;</span>: chain_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gasPrice&#34;</span>: w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>gas_price,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;from&#34;</span>: my_address,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nonce&#34;</span>: nonce,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=签名交易>签名交易
<a class=anchor href=#%e7%ad%be%e5%90%8d%e4%ba%a4%e6%98%93>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>signed_txn <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>account<span style=color:#f92672>.</span>sign_transaction(transaction, private_key<span style=color:#f92672>=</span>private_key)
</span></span></code></pre></div><h4 id=发送交易>发送交易
<a class=anchor href=#%e5%8f%91%e9%80%81%e4%ba%a4%e6%98%93>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>tx_hash <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>send_raw_transaction(signed_txn<span style=color:#f92672>.</span>rawTransaction)
</span></span><span style=display:flex><span>tx_receipt <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>wait_for_transaction_receipt(tx_hash)
</span></span></code></pre></div><h3 id=与合约交互>与合约交互
<a class=anchor href=#%e4%b8%8e%e5%90%88%e7%ba%a6%e4%ba%a4%e4%ba%92>#</a></h3><p>与部署合约步骤类似，我们可以通过 web3 库与合约交互，也分为构造交易、签名交易和发送交易三个步骤。</p><h4 id=构造交易-1>构造交易
<a class=anchor href=#%e6%9e%84%e9%80%a0%e4%ba%a4%e6%98%93-1>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>simple_storage <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>contract(address<span style=color:#f92672>=</span>tx_receipt<span style=color:#f92672>.</span>contractAddress, abi<span style=color:#f92672>=</span>abi)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>store_transaction <span style=color:#f92672>=</span> simple_storage<span style=color:#f92672>.</span>functions<span style=color:#f92672>.</span>store(<span style=color:#ae81ff>67</span>)<span style=color:#f92672>.</span>buildTransaction(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;chainId&#34;</span>: chain_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gasPrice&#34;</span>: w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>gas_price,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;from&#34;</span>: my_address,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nonce&#34;</span>: nonce <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=签名交易-1>签名交易
<a class=anchor href=#%e7%ad%be%e5%90%8d%e4%ba%a4%e6%98%93-1>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>signed_store_txn <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>account<span style=color:#f92672>.</span>sign_transaction(
</span></span><span style=display:flex><span>    store_transaction, private_key<span style=color:#f92672>=</span>private_key
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=发送交易-1>发送交易
<a class=anchor href=#%e5%8f%91%e9%80%81%e4%ba%a4%e6%98%93-1>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>send_store_tx <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>send_raw_transaction(signed_store_txn<span style=color:#f92672>.</span>rawTransaction)
</span></span><span style=display:flex><span>tx_receipt <span style=color:#f92672>=</span> w3<span style=color:#f92672>.</span>eth<span style=color:#f92672>.</span>wait_for_transaction_receipt(send_store_tx)
</span></span></code></pre></div><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>以上就是我们通过 Web3.py 库与本地 Ganache 测试网络进行交互的步骤，在真正的生产项目开发中我们一般不会直接使用 Web3.py 这样的库，而是会使用 Brownie、HardHat 等进一步封装的库，但了解 Web3.py 或 Web3.js 等库的使用方法也非常重要。</p><h2 id=参考资料>参考资料
<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>#</a></h2><blockquote><ol><li><a href=https://www.pseudoyu.com/zh/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=https://github.com/ethereum/web3.py>ethereum/web3.py</a></li><li><a href=https://github.com/smartcontractkit/full-blockchain-solidity-course-py>Solidity, Blockchain, and Smart Contract - Beginner to Expert Full Course | Python Edition</a></li></ol></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#web3py>Web3.py</a><ul><li><a href=#安装>安装</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#solidity-合约编译>Solidity 合约编译</a><ul><li><a href=#合约源码>合约源码</a></li><li><a href=#读取合约源文件>读取合约源文件</a></li><li><a href=#编译合约>编译合约</a></li></ul></li><li><a href=#本地-ganache-环境>本地 Ganache 环境</a><ul><li><a href=#ganache-gui>Ganache GUI</a></li><li><a href=#ganache-cli-安装>Ganache CLI 安装</a></li><li><a href=#通过-web3-连接本地-ganache-环境>通过 web3 连接本地 Ganache 环境</a></li></ul></li><li><a href=#solidity-合约部署>Solidity 合约部署</a><ul><li><a href=#创建合约>创建合约</a></li><li><a href=#部署合约>部署合约</a></li><li><a href=#与合约交互>与合约交互</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></aside></main></body></html>