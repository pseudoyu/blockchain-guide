<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Solidity 智能合约开发 - Hardhat 框架使用 # 前言 # 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的基础知识，不熟悉的同学可以回顾一下：
Solidity 智能合约开发 - 基础 Solidity 智能合约开发 - 玩转 Web3.py Solidity 智能合约开发 - 玩转 ethers.js 但是在真正的复杂业务场景中，我们往往会使用一些进一步封装的框架，如 HardHat、Brownie、Truffle 等，HardHat 是其中应用最广泛、插件拓展最为强大的。本系列将从这篇开始专注于 Hardhat 框架的使用与最佳实践，而本篇则会通过一个简单的例子完成其安装、配置与使用。
本文是对 Patrick Collins 的 『Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript』 教程的学习整理，强烈建议看原教程视频了解更多细节。
可以点击这里访问本测试 Demo 代码仓库。
Hardhat 介绍 # Hardhat 是一个基于 JavaScript 的智能合约开发环境，可以用于灵活地编译、部署、测试和调试基于 EVM 的智能合约，并且提供了一系列工具链来整合代码与外部工具，还提供了丰富的插件生态，提升开发效率。此外，它还提供了模拟以太坊的本地 Hardhat 网络节点，提供强大的本地调试功能。
其 GitHub 地址为 NomicFoundation/hardhat，可以访问其官方文档了解更多。
Hardhat 使用 # 初始化项目 # 从零开始搭建一个 Hardhat 项目，我们需要预先安装好 node."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Solidity 智能合约开发 - Hardhat 框架使用"><meta property="og:description" content="Solidity 智能合约开发 - Hardhat 框架使用 # 前言 # 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的基础知识，不熟悉的同学可以回顾一下：
Solidity 智能合约开发 - 基础 Solidity 智能合约开发 - 玩转 Web3.py Solidity 智能合约开发 - 玩转 ethers.js 但是在真正的复杂业务场景中，我们往往会使用一些进一步封装的框架，如 HardHat、Brownie、Truffle 等，HardHat 是其中应用最广泛、插件拓展最为强大的。本系列将从这篇开始专注于 Hardhat 框架的使用与最佳实践，而本篇则会通过一个简单的例子完成其安装、配置与使用。
本文是对 Patrick Collins 的 『Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript』 教程的学习整理，强烈建议看原教程视频了解更多细节。
可以点击这里访问本测试 Demo 代码仓库。
Hardhat 介绍 # Hardhat 是一个基于 JavaScript 的智能合约开发环境，可以用于灵活地编译、部署、测试和调试基于 EVM 的智能合约，并且提供了一系列工具链来整合代码与外部工具，还提供了丰富的插件生态，提升开发效率。此外，它还提供了模拟以太坊的本地 Hardhat 网络节点，提供强大的本地调试功能。
其 GitHub 地址为 NomicFoundation/hardhat，可以访问其官方文档了解更多。
Hardhat 使用 # 初始化项目 # 从零开始搭建一个 Hardhat 项目，我们需要预先安装好 node."><meta property="og:type" content="article"><meta property="og:url" content="https://guide.pseudoyu.com/docs/solidity/learn_solidity_from_scratch_hardhat/"><meta property="article:section" content="docs"><title>Solidity 智能合约开发 - Hardhat 框架使用 | 区块链入门指南</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/zh.search.min.b10711b05a0181502a3a97eebfe78d48592aa05311c1422adc3515e97c2f51ac.js integrity="sha256-sQcRsFoBgVAqOpfuv+eNSFkqoFMRwUIq3DUV6XwvUaw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>区块链入门指南</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><p><strong>开始学习</strong></p><ul><li><a href=/docs/study_path/>学习路径</a></li></ul></li><li><p><strong>基础知识</strong></p><ul><li><a href=/docs/blockchain/blockchain_basic/>区块链基础知识与关键技术</a></li><li><a href=/docs/bitcoin/blockchain_bitcoin_basic/>比特币核心技术解读</a></li><li><a href=/docs/ethereum/blockchain_ethereum_basic/>Ethereum 核心技术解读</a></li><li><a href=/docs/ethereum/blockchain_ethereum_mpt/>Ethereum MPT 详解</a></li><li><a href=/docs/solidity/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=/docs/solidity/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=/docs/solidity/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li><li><a href=/docs/solidity/learn_solidity_from_scratch_hardhat/ class=active>Solidity 智能合约开发 - Hardhat 框架使用</a></li><li><a href=/docs/solidity/two_phase_commit_contract_practice_in_solidity/>通过状态锁在 Solidity 智能合约中实现两阶段提交</a></li><li><a href=/docs/hyperledger_fabric/blockchain_hyperledger_fabric_structure/>Fabric 系统架构详解</a></li><li><a href=/docs/hyperledger_fabric/blockchain_hyperledger_fabric_network/>Fabric 网络与安全体系浅析</a></li><li><a href=/docs/hyperledger_fabric/blockchain_hyperledger_fabric_gosdk_event/>Fabric Go SDK 事件分析</a></li></ul></li><li><p><strong>热门技术</strong></p><ul><li><a href=/docs/ipfs/blockchain_ipfs_structure/>IPFS 技术分析与思考</a></li><li><a href=/docs/ipfs/blockchain_ipfs_practice/>IPFS 本地节点搭建</a></li><li><a href=/docs/crosschain/blockchain_crosschain/>跨链技术原理与实战</a></li><li><a href=/docs/baas/blockchain_baas_platform/>区块链服务平台 (BaaS) 简介</a></li></ul></li><li><p><strong>开发实战</strong></p></li><li><p><strong>附录：资源</strong></p></li><li><p><a href=https://github.com/pseudoyu/blockchain-guide><strong>Fork on Github</strong></a></p></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Solidity 智能合约开发 - Hardhat 框架使用</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#hardhat-介绍>Hardhat 介绍</a></li><li><a href=#hardhat-使用>Hardhat 使用</a><ul><li><a href=#初始化项目>初始化项目</a></li><li><a href=#初始化-hardhat>初始化 Hardhat</a></li><li><a href=#优化代码格式化>优化代码格式化</a></li><li><a href=#编译合约>编译合约</a></li><li><a href=#添加-dotenv-支持>添加 <code>dotenv</code> 支持</a></li><li><a href=#配置网络环境>配置网络环境</a></li><li><a href=#脚本>脚本</a></li><li><a href=#增加-etherscan-合约验证支持>增加 etherscan 合约验证支持</a></li><li><a href=#合约测试>合约测试</a></li><li><a href=#添加-gas-reporter-支持>添加 <code>gas-reporter</code> 支持</a></li><li><a href=#添加-solidity-coverage-支持>添加 <code>solidity-coverage</code> 支持</a></li><li><a href=#task>Task</a></li><li><a href=#hardhat-console>Hardhat Console</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></aside></header><article class=markdown><h1 id=solidity-智能合约开发---hardhat-框架使用>Solidity 智能合约开发 - Hardhat 框架使用
<a class=anchor href=#solidity-%e6%99%ba%e8%83%bd%e5%90%88%e7%ba%a6%e5%bc%80%e5%8f%91---hardhat-%e6%a1%86%e6%9e%b6%e4%bd%bf%e7%94%a8>#</a></h1><h2 id=前言>前言
<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h2><p>经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的基础知识，不熟悉的同学可以回顾一下：</p><ul><li><a href=https://www.pseudoyu.com/zh/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=https://www.pseudoyu.com/zh/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=https://www.pseudoyu.com/zh/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li></ul><p>但是在真正的复杂业务场景中，我们往往会使用一些进一步封装的框架，如 HardHat、Brownie、Truffle 等，HardHat 是其中应用最广泛、插件拓展最为强大的。本系列将从这篇开始专注于 Hardhat 框架的使用与最佳实践，而本篇则会通过一个简单的例子完成其安装、配置与使用。</p><p>本文是对 <a href=https://twitter.com/PatrickAlphaC>Patrick Collins</a> 的 『<a href="https://www.youtube.com/watch?v=gyMwXuJrbJQ">Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript</a>』 教程的学习整理，强烈建议看原教程视频了解更多细节。</p><p>可以点击<a href=https://github.com/pseudoyu/learn-solidity/tree/master/hardhat_simple_storage>这里</a>访问本测试 Demo 代码仓库。</p><h2 id=hardhat-介绍>Hardhat 介绍
<a class=anchor href=#hardhat-%e4%bb%8b%e7%bb%8d>#</a></h2><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_homepage.png alt=hardhat_homepage></p><p>Hardhat 是一个基于 JavaScript 的智能合约开发环境，可以用于灵活地编译、部署、测试和调试基于 EVM 的智能合约，并且提供了一系列工具链来整合代码与外部工具，还提供了丰富的插件生态，提升开发效率。此外，它还提供了模拟以太坊的本地 Hardhat 网络节点，提供强大的本地调试功能。</p><p>其 GitHub 地址为 <a href=https://github.com/NomicFoundation/hardhat>NomicFoundation/hardhat</a>，可以访问其<a href=https://hardhat.org/getting-started>官方文档</a>了解更多。</p><h2 id=hardhat-使用>Hardhat 使用
<a class=anchor href=#hardhat-%e4%bd%bf%e7%94%a8>#</a></h2><h3 id=初始化项目>初始化项目
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e9%a1%b9%e7%9b%ae>#</a></h3><p>从零开始搭建一个 Hardhat 项目，我们需要预先安装好 <code>node.js</code> 与 <code>yarn</code> 环境，这部份参照官方说明根据自己的系统环境按照即可。</p><p>首先，我们需要初始化项目并安装 <code>hardhat</code> 依赖包。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn init
</span></span><span style=display:flex><span>yarn add --dev hardhat
</span></span></code></pre></div><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add.png alt=yarn_add></p><h3 id=初始化-hardhat>初始化 Hardhat
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96-hardhat>#</a></h3><p>然后需要运行 <code>yarn hardhat</code>，通过交互式命令来进行初始化，根据项目需要进行配置，我们的测试 Demo 选择默认值。</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_project_init.png alt=hardhat_project_init></p><h3 id=优化代码格式化>优化代码格式化
<a class=anchor href=#%e4%bc%98%e5%8c%96%e4%bb%a3%e7%a0%81%e6%a0%bc%e5%bc%8f%e5%8c%96>#</a></h3><h4 id=vs-code-配置>VS Code 配置
<a class=anchor href=#vs-code-%e9%85%8d%e7%bd%ae>#</a></h4><p>我本地是通过 VS Code 进行代码开发的，可以通过安装 <code>Solidity + Hardhat</code> 与 <code>Prettier</code> 两个插件来进行代码格式化，可以使用打开 VS Code 设置，在 <code>settings.json</code> 中增加如下格式化配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;[solidity]&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;editor.defaultFormatter&#34;</span>: <span style=color:#e6db74>&#34;NomicFoundation.hardhat-solidity&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;[javascript]&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;editor.defaultFormatter&#34;</span>: <span style=color:#e6db74>&#34;esbenp.prettier-vscode&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=项目配置>项目配置
<a class=anchor href=#%e9%a1%b9%e7%9b%ae%e9%85%8d%e7%bd%ae>#</a></h4><p>为了统一各个使用项目的开发人员的代码格式化样式，我们还可以为项目配置 <code>prettier</code> 与 <code>prettier-plugin-solidity</code> 插件支持：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn add --dev prettier prettier-plugin-solidity
</span></span></code></pre></div><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add_prettier_plugin.png alt=yarn_add_prettier_plugin></p><p>添加依赖后，可以在项目目录增加 <code>.prettierrc</code> 与 <code>.prettierignore</code> 配置文件来进行格式化统一：</p><p>我的 <code>.prettierrc</code> 配置为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tabWidth&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;useTabs&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;semi&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;singleQuote&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我的 <code>.prettierignore</code> 配置为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>node_modules
</span></span><span style=display:flex><span>package.json
</span></span><span style=display:flex><span>img
</span></span><span style=display:flex><span>artifacts
</span></span><span style=display:flex><span>cache
</span></span><span style=display:flex><span>coverage
</span></span><span style=display:flex><span>.env
</span></span><span style=display:flex><span>.*
</span></span><span style=display:flex><span>README.md
</span></span><span style=display:flex><span>coverage.json
</span></span></code></pre></div><h3 id=编译合约>编译合约
<a class=anchor href=#%e7%bc%96%e8%af%91%e5%90%88%e7%ba%a6>#</a></h3><p>无需像 <code>ethers.js</code> 一样自定义 <code>compile</code> 命令，HardHat 预置了 <code>compile</code> 命令，可以将合约放在 <code>contracts</code> 目录下，然后通过 <code>yarn hardhat compile</code> 命令来编译合约：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_compile_contract.png alt=hardhat_compile_contract></p><h3 id=添加-dotenv-支持>添加 <code>dotenv</code> 支持
<a class=anchor href=#%e6%b7%bb%e5%8a%a0-dotenv-%e6%94%af%e6%8c%81>#</a></h3><p>在开始编写部署脚本之前，我们先配置一下 <code>dotenv</code> 插件，这样我们就可以使用 <code>dotenv</code> 来获取环境变量。我们在开发过程中，会牵扯到很多隐私信息，如私钥等，我们会希望将其存储在 <code>.env</code> 文件或直接设置在终端中，比如我们的 <code>RINKEBY_PRIVATE_TOKEN</code>，这样我们就可以在部署脚本中使用 <code>process.env.RINKEBY_PRIVATE_TOKEN</code> 获取到值，无需在代码中显式写入，减少隐私泄漏风险。</p><h4 id=安装-dotenv>安装 <code>dotenv</code>
<a class=anchor href=#%e5%ae%89%e8%a3%85-dotenv>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn add --dev dotenv
</span></span></code></pre></div><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add_dotenv.png alt=yarn_add_dotenv></p><h4 id=设置环境变量>设置环境变量
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f>#</a></h4><p>在 <code>.env</code> 文件中，我们可以设置环境变量，比如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>RINKEBY_RPC_URL=url
</span></span><span style=display:flex><span>RINKEBY_PRIVATE_KEY=0xkey
</span></span><span style=display:flex><span>ETHERSCAN_API_KEY=key
</span></span><span style=display:flex><span>COINMARKETCAP_API_KEY=key
</span></span></code></pre></div><p>我们就可以在 <code>hardhat.config.js</code> 中读取环境变量了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;dotenv&#34;</span>).<span style=color:#a6e22e>config</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>RINKEBY_RPC_URL</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>RINKEBY_RPC_URL</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;https://eth-rinkeby/example&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>RINKEBY_PRIVATE_KEY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>RINKEBY_PRIVATE_KEY</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;0xkey&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ETHERSCAN_API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>ETHERSCAN_API_KEY</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;key&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>COINMARKETCAP_API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>COINMARKETCAP_API_KEY</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;key&#34;</span>
</span></span></code></pre></div><h3 id=配置网络环境>配置网络环境
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e7%bd%91%e7%bb%9c%e7%8e%af%e5%a2%83>#</a></h3><p>往往我们的合约需要运行在不同的区块链网络上，如本地测试、开发、上线环境等等，HardHat 也提供了便捷的方式来配置网络环境。</p><h4 id=启动网络>启动网络
<a class=anchor href=#%e5%90%af%e5%8a%a8%e7%bd%91%e7%bb%9c>#</a></h4><p>我们可以直接运行脚本来启动一个 Hardhat 自带的网络，但该网络仅仅存活于脚本运行期间，想要启动一个本地可持续的网络，需要运行 <code>yarn hardhat node</code> 命令：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_localhost_node.png alt=hardhat_localhost_node></p><p>执行完成后，就生成了测试网络与测试账户，供后续开发调试使用。</p><p>我们还可以通过 Alchemy 或 Infura 等平台生成自己的测试网节点，记录其 <code>RPC_URL</code> 供程序连接使用。</p><h4 id=定义网络>定义网络
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e7%bd%91%e7%bb%9c>#</a></h4><p>完成网络环境准备后，我们可以在项目配置 <code>hardhat.config.js</code> 中定义网络：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>RINKEBY_RPC_URL</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>RINKEBY_RPC_URL</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;https://eth-rinkeby/example&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>RINKEBY_PRIVATE_KEY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>RINKEBY_PRIVATE_KEY</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;0xkey&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>defaultNetwork</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;hardhat&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>networks</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>locakhost</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://localhost:8545&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>chainId</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>31337</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rinkeby</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>RINKEBY_RPC_URL</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>accounts</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>RINKEBY_PRIVATE_KEY</span>],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>chainId</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=脚本>脚本
<a class=anchor href=#%e8%84%9a%e6%9c%ac>#</a></h3><p>在 Hardhat 项目中，我们可以通过在 <code>scripts</code> 目录中编写脚本来实现部署等功能，并且通过便捷的命令执行脚本。</p><h4 id=编写部署脚本>编写部署脚本
<a class=anchor href=#%e7%bc%96%e5%86%99%e9%83%a8%e7%bd%b2%e8%84%9a%e6%9c%ac>#</a></h4><p>接下来我们开始编写 <code>deploy.js</code> 脚本。</p><p>首先，我们需要从 <code>hardhat</code> 中导入必要包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ethers</span>, <span style=color:#a6e22e>run</span>, <span style=color:#a6e22e>network</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;hardhat&#34;</span>)
</span></span></code></pre></div><p>接着则编写 <code>main</code> 方法，包含我们的部署核心逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>SimpleStorageFactory</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>getContractFactory</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SimpleStorage&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Deploying SimpleStorage Contract...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>simpleStorage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>SimpleStorageFactory</span>.<span style=color:#a6e22e>deploy</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>deployed</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;SimpleStorage Contract deployed at:&#34;</span>, <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取当前值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>retrieve</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Current value:&#34;</span>, <span style=color:#a6e22e>currentValue</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>transactionResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>store</span>(<span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>transactionResponse</span>.<span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取更新后的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updatedValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>retrieve</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Updated value:&#34;</span>, <span style=color:#a6e22e>updatedValue</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后运行我们的 <code>main</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>error</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    })
</span></span></code></pre></div><h4 id=运行脚本>运行脚本
<a class=anchor href=#%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac>#</a></h4><p>完成脚本编写后，可以通过 Hardhat 提供的 <code>run</code> 命令来运行脚本。</p><p>如不加网络参数，则默认使用 <code>hardhat</code> 网络，可以通过 <code>--network</code> 参数指定网络：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn hardhat run scripts/deploy.js --network rinkeby
</span></span></code></pre></div><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_deploy_rinkeby.png alt=hardhat_deploy_rinkeby></p><h3 id=增加-etherscan-合约验证支持>增加 etherscan 合约验证支持
<a class=anchor href=#%e5%a2%9e%e5%8a%a0-etherscan-%e5%90%88%e7%ba%a6%e9%aa%8c%e8%af%81%e6%94%af%e6%8c%81>#</a></h3><p>将合约部署至 Rinkeby 测试网络后可在 Etherscan 上查看合约的地址，并且进行验证。我们可以通过网站进行操作，但 Hardhat 提供了插件支持，更方便进行验证操作。</p><h4 id=安装-hardhat-etherscan-插件>安装 hardhat-etherscan 插件
<a class=anchor href=#%e5%ae%89%e8%a3%85-hardhat-etherscan-%e6%8f%92%e4%bb%b6>#</a></h4><p>我们通过 <code>yarn add --dev @nomiclabs/hardhat-etherscan</code> 命令安装插件。</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add_etherscan_verify_support.png alt=yarn_add_etherscan_verify_support></p><h4 id=启用-etherscan-合约验证支持>启用 etherscan 合约验证支持
<a class=anchor href=#%e5%90%af%e7%94%a8-etherscan-%e5%90%88%e7%ba%a6%e9%aa%8c%e8%af%81%e6%94%af%e6%8c%81>#</a></h4><p>完成安装后，我们需要在 <code>hardhat.config.js</code> 中进行配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;@nomiclabs/hardhat-etherscan&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>etherscan</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ETHERSCAN_API_KEY</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h4 id=定义-verify-方法>定义 verify 方法
<a class=anchor href=#%e5%ae%9a%e4%b9%89-verify-%e6%96%b9%e6%b3%95>#</a></h4><p>接下来我们需要在部署脚本 <code>deploy.js</code> 中添加 <code>verify</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ethers</span>, <span style=color:#a6e22e>run</span>, <span style=color:#a6e22e>network</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;hardhat&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>contractAddress</span>, <span style=color:#a6e22e>args</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Verifying SimpleStorage Contract...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>run</span>(<span style=color:#e6db74>&#34;verify:verify&#34;</span>, {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>address</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>contractAddress</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>constructorArguements</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>args</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>toLowerCase</span>().<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#34;already verified!&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Already Verified!&#34;</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个方法我们调用了 <code>hardhat</code> 包中的 <code>run</code> 方法，并且传递了一个 <code>verify</code> 命令，并且传递了一个参数 <code>{ address: contractAddress, constructorArguements: args }</code>。因为可能我们的合约已经在 Etherscan 上验证过，所以我们做了一个 <code>try...catch...</code> 错误处理，如果验证过，则会抛出一个错误，并且输出一个提示信息，而不影响我们的部署流程。</p><h4 id=设置部署后调用>设置部署后调用
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e9%83%a8%e7%bd%b2%e5%90%8e%e8%b0%83%e7%94%a8>#</a></h4><p>定义好我们的 <code>verify</code> 方法后，我们可以在部署脚本中调用它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>chainId</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>ETHERSCAN_API_KEY</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>deployTransaction</span>.<span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>address</span>, [])
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>在这里我们做了两个特殊处理。</p><p>首先，我们仅需要在 <code>rinkeby</code> 网络上验证合约，而不需要在本地或其他网络环境验证，因此，我们对 <code>network.config.chainId</code> 进行判断，如果是 <code>4</code>，则执行验证操作；否则，不执行验证操作，此外仅在有 <code>ETHERSCAN_API_KEY</code> 环境变量时执行验证操作。</p><p>另外，Etherscan 可能需要在部署后一段时间才能获取到合约地址，因此我们配置了 <code>.wait(6)</code> 等待 6 个区块后再进行验证。</p><p>执行效果如下：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_verify_contract_etherscan.png alt=hardhat_verify_contract_etherscan></p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/verified_contract_on_etherscan.png alt=verified_contract_on_etherscan></p><p>我们通过 Etherscan 验证后访问后可以直接查看合约源码并进行交互。</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/interact_with_contract_on_etherscan.png alt=interact_with_contract_on_etherscan></p><h3 id=合约测试>合约测试
<a class=anchor href=#%e5%90%88%e7%ba%a6%e6%b5%8b%e8%af%95>#</a></h3><p>对于智能合约来说，其大多数操作都需要部署上链，与资产交互，消耗 gas，且一旦有安全隐患会造成严重的后果。因此，我们需要对智能合约进行详细的测试。</p><p>Hardhat 提供了完备的测试调试工具，可以在 <code>tests</code> 目录中编写测试脚本，通过 <code>yarn hardhat test</code> 命令运行测试。</p><h4 id=编写测试脚本>编写测试脚本
<a class=anchor href=#%e7%bc%96%e5%86%99%e6%b5%8b%e8%af%95%e8%84%9a%e6%9c%ac>#</a></h4><p>为我们的部署脚本编写 <code>test-deploy.js</code> 测试程序，首先需要导入必要包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>assert</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;chai&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ethers</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;hardhat&#34;</span>)
</span></span></code></pre></div><p>然后编写测试逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;SimpleStorage&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>simpleStorageFactory</span>, <span style=color:#a6e22e>simpleStorage</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>simpleStorageFactory</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>getContractFactory</span>(<span style=color:#e6db74>&#34;SimpleStorage&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>simpleStorage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorageFactory</span>.<span style=color:#a6e22e>deploy</span>()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should start with a favorite number of 0&#34;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>retrieve</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expectedValue</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>currentValue</span>.<span style=color:#a6e22e>toString</span>(), <span style=color:#a6e22e>expectedValue</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// expect(currentValue.toString()).to.equal(expectedValue)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should update when we call store&#34;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expectedValue</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;7&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>transactionRespense</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>store</span>(<span style=color:#a6e22e>expectedValue</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>transactionRespense</span>.<span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>simpleStorage</span>.<span style=color:#a6e22e>retrieve</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>currentValue</span>.<span style=color:#a6e22e>toString</span>(), <span style=color:#a6e22e>expectedValue</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// expect(currentValue.toString()).to.equal(expectedValue)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    })
</span></span></code></pre></div><p>在 Hardhat 的测试脚本中，我们使用 <code>describe</code> 包裹测试类，并且使用 <code>it</code> 包裹测试方法。我们需要保证测试前合约已经部署，因此，我们通过 <code>beforeEach</code> 方法在每个测试方法执行前都会调用 <code>simpleStorageFactory.deploy()</code>，并且将返回的 <code>simpleStorage</code> 对象赋值给 <code>simpleStorage</code> 变量。</p><p>我们使用 <code>assert.equal(currentValue.toString(), expectedValue)</code> 来对执行结果与预期结果进行比照，可以用 <code>expect(currentValue.toString()).to.equal(expectedValue)</code> 替代，效果一样。</p><p>此外，我们还可以通过 <code>it.only()</code> 来指定仅执行其中一个测试方法。</p><h4 id=执行测试脚本>执行测试脚本
<a class=anchor href=#%e6%89%a7%e8%a1%8c%e6%b5%8b%e8%af%95%e8%84%9a%e6%9c%ac>#</a></h4><p>我们通过 <code>yarn hardhat test</code> 运行测试，且可以通过 <code>yarn hardhat test --grep store</code> 来指定测试方法。</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_run_tests.png alt=hardhat_run_tests></p><h3 id=添加-gas-reporter-支持>添加 <code>gas-reporter</code> 支持
<a class=anchor href=#%e6%b7%bb%e5%8a%a0-gas-reporter-%e6%94%af%e6%8c%81>#</a></h3><p>如上文所述，gas 是我们在开发过程中需要特别关注的资源，尤其在 Ethereum 主网上尤其昂贵。因此，我们需要在测试过程中查看 gas 消耗情况。HardHat 也有一个 <code>gas-reporter</code> 插件，可以很方便地输出 gas 消耗情况。</p><h4 id=安装-gas-reporter-插件>安装 <code>gas-reporter</code> 插件
<a class=anchor href=#%e5%ae%89%e8%a3%85-gas-reporter-%e6%8f%92%e4%bb%b6>#</a></h4><p>我们通过 <code>yarn add --dev hardhat-gas-reporter</code> 命令来安装插件：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add_gas_reporter.png alt=yarn_add_gas_reporter></p><h4 id=启用-gas-reporter-支持>启用 <code>gas-reporter</code> 支持
<a class=anchor href=#%e5%90%af%e7%94%a8-gas-reporter-%e6%94%af%e6%8c%81>#</a></h4><p>我们通过在 <code>hardhat.config.js</code> 中添加 <code>gasReporter: true</code> 及额外配置项来启用插件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;hardhat-gas-reporter&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>COINMARKETCAP_API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>COINMARKETCAP_API_KEY</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;key&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gasReporter</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>enabled</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>outputFile</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;gas-reporter.txt&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>noColors</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currency</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;USD&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>coinmarketcap</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>COINMARKETCAP_API_KEY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;MATIC&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们可以指定输出文件、是否开启颜色、指定币种、指定代币名称，以及指定代币的 CoinMarketCap API 密钥来根据项目进一步控制输出。</p><p>按照以上配置，运行 <code>yarn hardhat test</code> 输出效果如下：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_add_gas_reporter_support_and_export.png alt=hardhat_add_gas_reporter_support_and_export></p><h3 id=添加-solidity-coverage-支持>添加 <code>solidity-coverage</code> 支持
<a class=anchor href=#%e6%b7%bb%e5%8a%a0-solidity-coverage-%e6%94%af%e6%8c%81>#</a></h3><p>合约测试对于保障业务逻辑正确性与安全防范至关重要，因此，我们需要对合约进行覆盖率测试。HardHat 也有一个 <code>solidity-coverage</code> 插件，可以很方便地输出覆盖率情况。</p><h4 id=安装-solidity-coverage-插件>安装 <code>solidity-coverage</code> 插件
<a class=anchor href=#%e5%ae%89%e8%a3%85-solidity-coverage-%e6%8f%92%e4%bb%b6>#</a></h4><p>我们通过 <code>yarn add --dev solidity-coverage</code> 命令来安装插件：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/yarn_add_coverage_support.png alt=yarn_add_coverage_support></p><h4 id=启用-solidity-coverage-支持>启用 <code>solidity-coverage</code> 支持
<a class=anchor href=#%e5%90%af%e7%94%a8-solidity-coverage-%e6%94%af%e6%8c%81>#</a></h4><p>我们仅需在 <code>hardhat.config.js</code> 中导入包即可添加覆盖率测试支持：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;solidity-coverage&#34;</span>)
</span></span></code></pre></div><h4 id=运行覆盖率测试>运行覆盖率测试
<a class=anchor href=#%e8%bf%90%e8%a1%8c%e8%a6%86%e7%9b%96%e7%8e%87%e6%b5%8b%e8%af%95>#</a></h4><p>通过 <code>yarn hardhat coverage</code> 即可运行覆盖率测试：</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_coverage.png alt=hardhat_coverage></p><h3 id=task>Task
<a class=anchor href=#task>#</a></h3><p>上文我们对 <code>hardhat</code> 库的基础功能与脚本进行了一些使用。除此之外，我们还可以自定义一些任务供开发调试使用。</p><h4 id=编写-task>编写 Task
<a class=anchor href=#%e7%bc%96%e5%86%99-task>#</a></h4><p>Hardhat 中，我们将任务定义在 <code>tasks</code> 目录下，我们将编写一个 <code>block-number.js</code> 的 Task 来获取区块高度：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>task</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;hardhat/config&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>task</span>(<span style=color:#e6db74>&#34;block-number&#34;</span>, <span style=color:#e6db74>&#34;Prints the current block number&#34;</span>).<span style=color:#a6e22e>setAction</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>taskArgs</span>, <span style=color:#a6e22e>hre</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>blockNumber</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>hre</span>.<span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>getBlockNumber</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Current Block Number: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>blockNumber</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Task 通过 <code>task()</code> 方法来创建，并通过 <code>setAction()</code> 方法来设置任务的执行函数。其中，<code>taskArgs</code> 是一个包含所有参数的对象，<code>hre</code> 是一个 <code>HardhatRuntimeEnvironment</code> 对象，可以用来获取其他的资源。</p><h4 id=运行-task>运行 Task
<a class=anchor href=#%e8%bf%90%e8%a1%8c-task>#</a></h4><p>定义完成后，在项目命令的 <code>AVAILABLE TASKS</code> 中就有了我们刚定义好的 <code>block-number</code> 任务，可以通过 <code>yarn hardhat block-number</code> 命令来运行任务，同样的，我们可以指定特定网络运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn hardhat block-number --network rinkeby
</span></span></code></pre></div><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_run_tasks.png alt=hardhat_run_tasks></p><h3 id=hardhat-console>Hardhat Console
<a class=anchor href=#hardhat-console>#</a></h3><p>最后，除了通过代码与链/合约进行交互外，我们还可以通过 <code>Hardhat Console</code> 来调试项目，查看链状态，合约的输入、输出等。我们可以通过 <code>yarn hardhat console</code> 命令来打开 Hardhat Console，并进行交互。</p><p><img src=https://pseudoyu.oss-cn-hangzhou.aliyuncs.com/images/hardhat_console.png alt=hardhat_console></p><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>以上就是我对 Hardhat 框架的基础配置与使用，它是一个很强大的开发框架，我后续还将会继续深入了解它的更多特性与使用技巧，如果有兴趣，可以继续关注，希望对大家有所帮助。</p><h2 id=参考资料>参考资料
<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>#</a></h2><blockquote><ol><li><a href="https://www.youtube.com/watch?v=gyMwXuJrbJQ">Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript</a></li><li><a href=https://github.com/NomicFoundation/hardhat>NomicFoundation/hardhat</a></li><li><a href=https://hardhat.org/getting-started>Hardhat 官方文档</a></li><li><a href=https://www.pseudoyu.com/zh/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=https://www.pseudoyu.com/zh/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=https://www.pseudoyu.com/zh/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li></ol></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#hardhat-介绍>Hardhat 介绍</a></li><li><a href=#hardhat-使用>Hardhat 使用</a><ul><li><a href=#初始化项目>初始化项目</a></li><li><a href=#初始化-hardhat>初始化 Hardhat</a></li><li><a href=#优化代码格式化>优化代码格式化</a></li><li><a href=#编译合约>编译合约</a></li><li><a href=#添加-dotenv-支持>添加 <code>dotenv</code> 支持</a></li><li><a href=#配置网络环境>配置网络环境</a></li><li><a href=#脚本>脚本</a></li><li><a href=#增加-etherscan-合约验证支持>增加 etherscan 合约验证支持</a></li><li><a href=#合约测试>合约测试</a></li><li><a href=#添加-gas-reporter-支持>添加 <code>gas-reporter</code> 支持</a></li><li><a href=#添加-solidity-coverage-支持>添加 <code>solidity-coverage</code> 支持</a></li><li><a href=#task>Task</a></li><li><a href=#hardhat-console>Hardhat Console</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></aside></main></body></html>